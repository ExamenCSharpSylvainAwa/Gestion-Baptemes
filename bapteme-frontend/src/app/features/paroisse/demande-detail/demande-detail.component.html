<div class="demande-detail-page">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <p-card>
      <p-skeleton height="200px" styleClass="mb-3"></p-skeleton>
      <p-skeleton height="400px"></p-skeleton>
    </p-card>
  </div>

  <!-- Content -->
  <div *ngIf="!loading && demande" class="content-container">
    <!-- Header -->
    <div class="page-header">
      <div>
        <h1>Traitement de la demande</h1>
        <p class="subtitle">{{ demande.reference }}</p>
      </div>
      <button pButton 
              label="Retour" 
              icon="pi pi-arrow-left"
              routerLink="/paroisse/demandes"
              class="p-button-outlined"></button>
    </div>

    <!-- Status Banner -->
<div class="status-banner" [ngClass]="'status-' + demande.statut">
  <div class="status-content">
    <p-tag [value]="demande.statut_label" 
           [severity]="getStatutSeverity(demande.statut)">
    </p-tag>
    <p class="status-message">
      <span *ngIf="isPaid()">
        <i class="pi pi-check-circle"></i> Paiement effectué
      </span>
      <span *ngIf="!isPaid()">
        <i class="pi pi-clock"></i> En attente de paiement
      </span>
    </p>
  </div>
  <div class="status-actions" *ngIf="canProcess()">
    <button pButton 
            label="Valider la demande" 
            icon="pi pi-check"
            (click)="showSearchResults ? showValidationDialog = true : searchBaptemes()"
            [disabled]="!isPaid() || baptemesRecherche.length === 0"
            class="p-button-success"></button>
    <button pButton 
            label="Rejeter" 
            icon="pi pi-times"
            (click)="showRejetDialog = true"
            class="p-button-danger p-button-outlined"></button>
  </div>
</div>
    <!-- Alert si pas payé -->
    <p-message 
      *ngIf="!isPaid() && canProcess()"
      severity="warn" 
      text="⚠️ Le demandeur n'a pas encore effectué le paiement. Vous pouvez traiter la demande mais elle ne sera finalisée qu'après paiement."
      styleClass="w-full mb-3">
    </p-message>

    <!-- Main Grid -->
    <div class="content-grid">
      <!-- Left Column: Informations demande -->
      <div class="left-column">
        <p-card header="Informations du demandeur">
          <div class="user-card">
            <div class="user-avatar">
              <i class="pi pi-user"></i>
            </div>
            <div class="user-details">
              <h3>{{ demande.user.name }}</h3>
              <p><i class="pi pi-envelope"></i> {{ demande.user.email }}</p>
              <p *ngIf="demande.user.phone">
                <i class="pi pi-phone"></i> {{ demande.user.phone }}
              </p>
            </div>
          </div>

          <p-divider></p-divider>

          <h4>Critères de recherche</h4>
          <div class="info-grid">
            <div class="info-item">
              <label>Prénom(s)</label>
              <p>{{ demande.prenoms_recherche }}</p>
            </div>
            <div class="info-item">
              <label>Nom</label>
              <p>{{ demande.nom_recherche }}</p>
            </div>
            <div class="info-item" *ngIf="demande.date_naissance_recherche">
              <label>Date de naissance</label>
              <p>{{ demande.date_naissance_recherche | date:'dd/MM/yyyy' }}</p>
            </div>
            <div class="info-item" *ngIf="demande.nom_pere_recherche">
              <label>Nom du père</label>
              <p>{{ demande.nom_pere_recherche }}</p>
            </div>
            <div class="info-item" *ngIf="demande.nom_mere_recherche">
              <label>Nom de la mère</label>
              <p>{{ demande.nom_mere_recherche }}</p>
            </div>
          </div>
        </p-card>

       <!-- Paiement -->
<p-card header="Informations de paiement">
  <div class="payment-info">
    <div class="payment-row">
      <span>Montant</span>
      <strong class="amount">{{ demande.montant_formatte }}</strong>
    </div>
    <p-divider></p-divider>
    
    <div *ngIf="isPaid()" class="payment-status paid">
      <i class="pi pi-check-circle"></i>
      <div>
        <strong>Paiement confirmé</strong>
        <p *ngIf="demande.paiement">
          Méthode : {{ getMethodeLabel(demande.paiement.methode) }}
        </p>
        <p *ngIf="demande.paiement?.reference">
          Réf: {{ demande.paiement?.reference }}
        </p>
      </div>
    </div>

    <div *ngIf="!isPaid()" class="payment-status pending">
      <i class="pi pi-clock"></i>
      <div>
        <strong>En attente de paiement</strong>
        <p>Le demandeur doit effectuer le paiement</p>
      </div>
    </div>
  </div>
</p-card>

      <!-- Right Column: Résultats de recherche -->
      <div class="right-column">
        <p-card>
          <ng-template pTemplate="header">
            <div class="card-header-flex">
              <h3>
                <i class="pi pi-search"></i>
                Résultats de recherche
              </h3>
              <button pButton 
                      icon="pi pi-refresh" 
                      (click)="searchBaptemes()"
                      [loading]="searchingBaptemes"
                      class="p-button-sm p-button-outlined"
                      pTooltip="Relancer la recherche"></button>
            </div>
          </ng-template>

          <!-- Loading -->
          <div *ngIf="searchingBaptemes" class="search-loading">
            <i class="pi pi-spin pi-spinner"></i>
            <p>Recherche en cours dans les registres...</p>
          </div>

          <!-- No results -->
          <div *ngIf="!searchingBaptemes && showSearchResults && baptemesRecherche.length === 0" 
               class="no-results">
            <i class="pi pi-info-circle"></i>
            <h4>Aucun baptême trouvé</h4>
            <p>Aucune correspondance trouvée avec les critères de recherche.</p>
            <button pButton 
                    label="Rejeter la demande" 
                    icon="pi pi-times"
                    (click)="showRejetDialog = true"
                    class="p-button-danger p-button-sm"></button>
          </div>

          <!-- Results Table -->
          <div *ngIf="!searchingBaptemes && showSearchResults && baptemesRecherche.length > 0">
            <p-message 
              severity="success" 
              [text]="baptemesRecherche.length + ' baptême(s) trouvé(s)'"
              styleClass="w-full mb-3">
            </p-message>

            <p-table [value]="baptemesRecherche" 
                     styleClass="p-datatable-sm"
                     responsiveLayout="scroll">
              <ng-template pTemplate="header">
                <tr>
                  <th>Nom complet</th>
                  <th>Date naissance</th>
                  <th>Date baptême</th>
                  <th>Parents</th>
                  <th style="width: 100px;">Match</th>
                  <th style="width: 80px;">Action</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-bapteme>
                <tr [ngClass]="{'match-high': getMatchScore(bapteme) >= 80, 'match-medium': getMatchScore(bapteme) >= 50 && getMatchScore(bapteme) < 80}">
                  <td>
                    <strong>{{ bapteme.prenoms }} {{ bapteme.nom }}</strong>
                  </td>
                  <td>{{ bapteme.date_naissance | date:'dd/MM/yyyy' }}</td>
                  <td>{{ bapteme.date_bapteme | date:'dd/MM/yyyy' }}</td>
                  <td>
                    <small>
                      Père: {{ bapteme.nom_pere }}<br>
                      Mère: {{ bapteme.nom_mere }}
                    </small>
                  </td>
                  <td>
                    <div class="match-score">
                      <span class="score-value">{{ getMatchScore(bapteme) }}%</span>
                      <div class="score-bar">
                        <div class="score-fill" 
                             [style.width.%]="getMatchScore(bapteme)"
                             [ngClass]="{
                               'score-high': getMatchScore(bapteme) >= 80,
                               'score-medium': getMatchScore(bapteme) >= 50 && getMatchScore(bapteme) < 80,
                               'score-low': getMatchScore(bapteme) < 50
                             }"></div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <button pButton 
                            icon="pi pi-check" 
                            (click)="selectBapteme(bapteme)"
                            class="p-button-rounded p-button-success p-button-sm"
                            pTooltip="Sélectionner"></button>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </p-card>
      </div>
    </div>
  </div>
</div>

<!-- Dialog: Confirmation sélection baptême -->
<p-dialog 
  [(visible)]="showBaptemeDialog" 
  header="Confirmer la sélection"
  [modal]="true"
  [style]="{width: '600px'}">
  
  <div *ngIf="selectedBapteme" class="bapteme-confirmation">
    <p-message 
      severity="info" 
      text="Veuillez vérifier que ce baptême correspond bien à la demande"
      styleClass="w-full mb-3">
    </p-message>

    <div class="bapteme-card">
      <h3>{{ selectedBapteme.prenoms }} {{ selectedBapteme.nom }}</h3>
      
      <div class="info-grid">
        <div class="info-item">
          <label>Date de naissance</label>
          <p>{{ selectedBapteme.date_naissance | date:'dd/MM/yyyy' }}</p>
        </div>
        <div class="info-item">
          <label>Lieu de naissance</label>
          <p>{{ selectedBapteme.lieu_naissance }}</p>
        </div>
        <div class="info-item">
          <label>Date de baptême</label>
          <p>{{ selectedBapteme.date_bapteme | date:'dd/MM/yyyy' }}</p>
        </div>
        <div class="info-item">
          <label>Célébrant</label>
          <p>{{ selectedBapteme.celebrant }}</p>
        </div>
        <div class="info-item">
          <label>Père</label>
          <p>{{ selectedBapteme.nom_pere }}</p>
        </div>
        <div class="info-item">
          <label>Mère</label>
          <p>{{ selectedBapteme.nom_mere }}</p>
        </div>
      </div>

      <div class="match-info">
        <strong>Taux de correspondance : {{ getMatchScore(selectedBapteme) }}%</strong>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton 
            label="Annuler" 
            icon="pi pi-times"
            (click)="showBaptemeDialog = false"
            class="p-button-text"></button>
    <button pButton 
            label="Confirmer et valider" 
            icon="pi pi-check"
            (click)="confirmBaptemeSelection()"
            class="p-button-success"></button>
  </ng-template>
</p-dialog>

<!-- Dialog: Validation finale -->
<p-dialog 
  [(visible)]="showValidationDialog" 
  header="Validation de la demande"
  [modal]="true"
  [style]="{width: '500px'}">
  
  <p-message 
    severity="warn" 
    text="⚠️ Un extrait de baptême sera automatiquement généré et envoyé au demandeur."
    styleClass="w-full mb-3">
  </p-message>

  <p><strong>Confirmez-vous la validation de cette demande ?</strong></p>
  <p>Le demandeur recevra une notification par email.</p>

  <ng-template pTemplate="footer">
    <button pButton 
            label="Annuler" 
            icon="pi pi-times"
            (click)="showValidationDialog = false"
            [disabled]="processing"
            class="p-button-text"></button>
    <button pButton 
            label="Valider" 
            icon="pi pi-check"
            (click)="validerDemande()"
            [loading]="processing"
            class="p-button-success"></button>
  </ng-template>
</p-dialog>

<!-- Dialog: Rejet -->
<p-dialog 
  [(visible)]="showRejetDialog" 
  header="Rejeter la demande"
  [modal]="true"
  [style]="{width: '500px'}">
  
  <form [formGroup]="rejetForm">
    <p-message 
      severity="error" 
      text="Le demandeur sera notifié du rejet avec le motif indiqué."
      styleClass="w-full mb-3">
    </p-message>

    <div class="form-field">
      <label for="motif">Motif du rejet *</label>
      <textarea pInputTextarea
                id="motif"
                formControlName="motif_rejet"
                rows="5"
                placeholder="Expliquez pourquoi la demande est rejetée..."
                class="w-full"></textarea>
      <small class="p-error" *ngIf="motif_rejet && motif_rejet.invalid && motif_rejet.touched">
        <span *ngIf="motif_rejet.errors?.['required']">Le motif est requis</span>
        <span *ngIf="motif_rejet.errors?.['minlength']">Minimum 10 caractères</span>
      </small>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton 
            label="Annuler" 
            icon="pi pi-times"
            (click)="showRejetDialog = false"
            [disabled]="processing"
            class="p-button-text"></button>
    <button pButton 
            label="Rejeter" 
            icon="pi pi-check"
            (click)="rejeterDemande()"
            [loading]="processing"
            [disabled]="rejetForm.invalid"
            class="p-button-danger"></button>
  </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>